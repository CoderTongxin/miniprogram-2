# 自动登录跳转使用指南

## 功能概述

小程序启动时会自动检查用户登录状态和伴侣绑定状态，如果满足条件，将自动跳转到首页，提供无缝的用户体验。

## 触发条件

自动跳转需要同时满足以下**所有条件**：

1. ✅ 用户已登录（有 `userInfo` 和 `_openid`）
2. ✅ 已绑定伴侣（`relationStatus === 'paired'`）
3. ✅ 有伴侣ID（`partnerId` 存在）
4. ✅ 从登录页打开（不是其他页面跳转）

## 实现逻辑

### 代码实现
```javascript
// pages/login/index.js
checkLoginStatus() {
  const userInfo = wx.getStorageSync('userInfo');
  
  if (userInfo && userInfo._openid) {
    // 已登录，检查是否已绑定伴侣
    if (userInfo.relationStatus === 'paired' && userInfo.partnerId) {
      // 已登录且已绑定伴侣，自动跳转到首页
      console.log('用户已登录且已绑定伴侣，自动跳转首页');
      
      // 保存到全局数据
      app.globalData.userInfo = userInfo;
      app.globalData.partnerId = userInfo.partnerId;
      
      // 延迟跳转，让用户看到加载动画
      setTimeout(() => {
        wx.hideLoading();
        wx.reLaunch({
          url: '/pages/home/index'
        });
      }, 500);
    } else {
      // 已登录但未绑定伴侣，显示登录页面
      this.setData({
        isLoggedIn: true,
        userInfo: userInfo
      });
    }
  } else {
    // 未登录，显示登录页面
  }
}
```

## 执行流程

### 情况1：已登录且已绑定（自动跳转）
```
打开小程序
  ↓
加载登录页（onLoad）
  ↓
显示 Loading 动画
  ↓
检查本地存储 userInfo
  ↓
发现已登录（有 _openid）
  ↓
检查 relationStatus
  ↓
状态为 'paired'
  ↓
保存到全局数据
  ↓
延迟 0.5 秒
  ↓
自动跳转到首页 ✨
  ↓
首页正常显示
```

**用户感知**：打开小程序 → 短暂 Loading → 直接进入首页

### 情况2：已登录但未绑定（显示登录页）
```
打开小程序
  ↓
检查登录状态
  ↓
已登录但 relationStatus !== 'paired'
  ↓
显示登录页
  ↓
显示"进入首页"按钮
  ↓
用户点击后提示绑定伴侣
```

**用户感知**：打开小程序 → 看到登录页 → 显示已登录状态 → 可以进入首页或绑定伴侣

### 情况3：未登录（显示登录页）
```
打开小程序
  ↓
检查登录状态
  ↓
未登录（无 userInfo）
  ↓
显示登录页
  ↓
显示"微信授权登录"按钮
  ↓
用户点击授权登录
```

**用户感知**：打开小程序 → 看到登录页 → 点击授权登录

## 不同场景对比

| 场景 | 登录状态 | 绑定状态 | 页面显示 | 用户操作 |
|------|---------|---------|---------|---------|
| 场景1 | ✅ 已登录 | ✅ 已绑定 | 直接跳转首页 | 无需操作 ✨ |
| 场景2 | ✅ 已登录 | ❌ 未绑定 | 显示登录页 | 点击"进入首页" |
| 场景3 | ❌ 未登录 | - | 显示登录页 | 点击"授权登录" |

## 跳转方式

### 使用 wx.reLaunch
```javascript
wx.reLaunch({
  url: '/pages/home/index'
});
```

**为什么用 reLaunch？**
- ✅ 关闭所有页面，打开首页
- ✅ 清空页面栈，用户无法返回登录页
- ✅ 避免页面堆栈过深
- ✅ 确保首页是根页面

### 不用 navigateTo 的原因
- ❌ 会保留登录页在页面栈中
- ❌ 用户可以返回登录页
- ❌ 页面栈会越来越深

## 时间控制

### Loading 动画时间
```javascript
// 延迟 0.3 秒后跳转
setTimeout(() => {
  wx.hideLoading();
  wx.reLaunch({
    url: '/pages/home/index'
  });
}, 300);
```

**为什么要延迟？**
1. 让用户看到 Loading 动画（体验更好）
2. 给云函数一些执行时间
3. 避免页面闪烁
4. 过渡更自然
5. 0.3秒是最佳平衡点：既快速又流畅

## 数据同步

### 保存到全局数据
```javascript
// 保存到全局
app.globalData.userInfo = userInfo;
app.globalData.partnerId = userInfo.partnerId;
```

**作用**：
- 首页可以直接使用全局数据
- 避免重复从本地存储读取
- 确保数据一致性

## 用户体验优化

### 优化前
1. 打开小程序 → 登录页
2. 看到"进入首页"按钮
3. 点击按钮
4. 进入首页

**操作次数**：1次点击

### 优化后
1. 打开小程序 → 短暂 Loading → 首页

**操作次数**：0次点击 ✨

**优化效果**：
- 减少用户操作步骤
- 提升启动速度感知
- 更流畅的使用体验

## 边界情况处理

### 情况1：本地数据过期
- 本地存储的 userInfo 可能过期
- 首页会重新验证登录状态
- 如果失效，会跳回登录页

### 情况2：伴侣解绑
- 本地显示已绑定，但云端已解绑
- 首页加载时会发现状态不一致
- 提示用户重新绑定

### 情况3：网络异常
- 跳转不依赖网络
- 使用本地存储的数据
- 首页会尝试同步云端数据

## 测试步骤

### 测试自动跳转
1. 用户 A 登录并绑定伴侣
2. 关闭小程序
3. 重新打开小程序
4. **验证自动跳转到首页** ✅

### 测试显示登录页
1. 新用户打开小程序
2. **验证显示登录页** ✅
3. 或：已登录但未绑定的用户
4. **验证显示登录页** ✅

### 测试登录后跳转
1. 新用户在登录页授权登录
2. 登录成功，绑定伴侣
3. 关闭小程序
4. 重新打开
5. **验证自动跳转** ✅

## 常见问题

### Q1: 为什么还是显示登录页？
**A:** 检查以下几点：
1. 是否真的已登录？（查看本地存储）
2. `relationStatus` 是否为 `'paired'`？
3. `partnerId` 是否存在？
4. 查看控制台日志

### Q2: 跳转后首页数据不对？
**A:**
- 首页会重新加载数据
- 如果本地数据过期，会提示重新登录
- 检查云端用户状态

### Q3: 能否跳转到其他页面？
**A:**
- 当前设计只跳转首页
- 如需跳转其他页面，修改 URL 参数
- 建议统一跳转首页，保持一致性

### Q4: 跳转太快/太慢？
**A:**
- 调整延迟时间（当前 0.5 秒）
- 平衡用户体验和加载速度
- 可以根据实际情况调整

## 日志输出

### 成功自动跳转
```
用户已登录且已绑定伴侣，自动跳转首页
自动跳转首页成功
```

### 显示登录页
```
// 无特殊日志
// 正常显示登录页面
```

### 跳转失败
```
自动跳转首页失败：{error message}
```

## 相关配置

### app.json
确保首页在页面列表中：
```json
{
  "pages": [
    "pages/login/index",
    "pages/home/index",
    // ...
  ]
}
```

### 页面配置
登录页 `index.json`：
```json
{
  "navigationBarTitleText": "You and Me"
}
```

## 性能优化

### 1. 快速判断
- 先检查本地存储
- 避免不必要的云函数调用
- 减少启动时间

### 2. 数据预加载
- 自动跳转时保存全局数据
- 首页直接使用，无需重新读取

### 3. 异常处理
- 跳转失败时显示登录页
- 不影响正常登录流程

## 总结

自动登录跳转功能的优势：

1. ✅ **无缝体验**：老用户直接进入首页
2. ✅ **减少操作**：0次点击即可使用
3. ✅ **智能判断**：自动识别登录和绑定状态
4. ✅ **友好提示**：未满足条件时正常显示登录页
5. ✅ **数据同步**：自动保存到全局数据
6. ✅ **性能优化**：本地判断，快速响应

这个功能大大提升了老用户的使用体验，让小程序启动更加流畅自然！🎉
