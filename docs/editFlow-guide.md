# 创建/编辑电子流页面使用指南

## 功能概述

创建/编辑页面已完成真实的云开发功能，支持创建新的电子流申请和编辑已驳回的申请。

## 已实现功能

### 1. 页面模式
- ✅ **创建模式**：直接打开页面，创建新的电子流申请
- ✅ **编辑模式**：通过 URL 参数传入 flowId，编辑已驳回的申请

### 2. 表单功能
- ✅ **申请内容**：必填，最多 500 字，支持多行输入
- ✅ **申请金额**：条件必填（非"其他"类型必填），支持小数
- ✅ **申请类型**：必选，三种类型（拨款/出行/其他）
- ✅ **审批人**：自动显示伴侣信息

### 3. 数据验证
- ✅ 申请内容不能为空
- ✅ 必须选择申请类型
- ✅ 非"其他"类型时金额必填且大于 0
- ✅ 金额格式验证

### 4. 云端集成
- ✅ 自动获取伴侣信息作为审批人
- ✅ 调用云函数创建/更新电子流
- ✅ 权限检查（未绑定伴侣不能创建）
- ✅ 编辑模式下只能编辑已驳回的申请

## 样式优化

### 修复的问题
1. ✅ **申请内容输入区宽度被挤压** - 使用独立的 content-input 区域
2. ✅ **申请金额没有对齐** - 设置 input 右对齐
3. ✅ **申请类型图标背景色不正确** - 未选中为白色，选中为浅蓝色

### 当前样式
- 未选中类型：白色背景 + 灰色边框
- 选中类型：浅蓝色背景 (#F0F5FF) + 蓝色边框
- 输入框宽度：充满父容器
- 金额输入：右对齐显示

## 使用流程

### 创建电子流

1. **打开页面**
   ```javascript
   wx.navigateTo({
     url: '/pages/editFlow/index'
   })
   ```

2. **填写表单**
   - 输入申请内容（必填）
   - 输入金额（条件必填）
   - 选择类型（必选）
   - 审批人自动显示

3. **提交申请**
   - 点击"提交"按钮
   - 自动验证表单
   - 调用云函数创建
   - 成功后返回首页

### 编辑电子流

1. **打开编辑页**
   ```javascript
   wx.navigateTo({
     url: `/pages/editFlow/index?id=${flowId}`
   })
   ```

2. **自动加载数据**
   - 从云端获取电子流详情
   - 验证是否为已驳回状态
   - 填充表单数据

3. **修改并提交**
   - 修改申请内容/金额/类型
   - 点击"提交"更新
   - 状态重置为"待审批"

## 权限控制

### 创建权限
- ✅ 必须已登录
- ✅ 必须已绑定伴侣
- ✅ 伴侣关系必须为 'paired'

### 编辑权限
- ✅ 只能编辑自己创建的申请
- ✅ 只能编辑已驳回的申请
- ✅ 编辑后状态重置为待审批

## 数据流转

### 创建流程
```
打开页面
  ↓
loadUserInfo (获取用户和伴侣信息)
  ↓
检查是否已绑定伴侣
  ↓
显示伴侣作为审批人
  ↓
用户填写表单
  ↓
点击提交
  ↓
验证表单数据
  ↓
调用 flowManager.create
  ↓
创建成功，返回首页
```

### 编辑流程
```
打开页面（带 flowId）
  ↓
loadUserInfo
  ↓
loadFlowData (获取电子流详情)
  ↓
验证状态（必须是 rejected）
  ↓
填充表单数据
  ↓
用户修改表单
  ↓
点击提交
  ↓
验证表单数据
  ↓
调用 flowManager.update
  ↓
更新成功，返回首页
```

## 云函数调用

### 创建电子流
```javascript
wx.cloud.callFunction({
  name: 'flowManager',
  data: {
    action: 'create',
    flowData: {
      content: '申请内容',
      amount: '100.00',  // 字符串格式
      type: 'funds'      // funds/travel/other
    }
  }
})
```

**响应数据**：
```javascript
{
  success: true,
  message: '创建成功',
  data: {
    flowId: 'xxx'
  }
}
```

### 更新电子流
```javascript
wx.cloud.callFunction({
  name: 'flowManager',
  data: {
    action: 'update',
    flowId: 'xxx',
    flowData: {
      content: '修改后的内容',
      amount: '200.00',
      type: 'travel'
    }
  }
})
```

**响应数据**：
```javascript
{
  success: true,
  message: '更新成功'
}
```

## 表单验证规则

### 申请内容
- 类型：文本
- 必填：是
- 最大长度：500 字符
- 验证：不能为空或纯空格

### 申请金额
- 类型：数字（可带小数）
- 必填：条件（类型不是"其他"时必填）
- 格式：正数，可以为 0
- 验证：必须是有效数字

### 申请类型
- 类型：单选
- 必填：是
- 选项：funds（拨款）、travel（出行）、other（其他）
- 特殊规则：选择"其他"时金额变为选填

### 审批人
- 自动填充：从云端获取伴侣信息
- 不可修改：审批人固定为伴侣
- 显示内容：头像、昵称、角色

## 页面状态

### 加载状态
- 进入页面时显示 loading
- 提交时显示"提交中..."或"更新中..."
- 加载完成后隐藏 loading

### 错误处理
- 未登录：提示并跳转到登录页
- 未绑定伴侣：提示并返回上一页
- 非已驳回状态：提示并返回上一页（编辑模式）
- 提交失败：显示错误信息

### 成功反馈
- 创建成功：Toast 提示"提交成功"
- 更新成功：Toast 提示"更新成功"
- 1.5 秒后自动返回上一页

## 特殊规则

### "其他"类型特殊处理
当用户选择"其他"类型时：
- 金额字段变为选填
- 显示橙色提示文字
- 提交时允许金额为空
- 金额为空时云端存储为 0

### 金额处理
- 前端：以字符串形式保存（如 "100.00"）
- 云端：转换为分（整数）存储（如 10000）
- 显示：格式化为元，保留两位小数

## UI 组件

### TDesign 组件使用
- `t-cell-group`：表单分组容器
- `t-cell`：表单项标题
- `t-textarea`：多行文本输入
- `t-input`：单行文本输入
- `t-button`：操作按钮
- `t-toast`：提示消息

### 自定义组件
- `content-input`：申请内容输入区
- `amount-input`：申请金额输入区
- `type-grid`：申请类型选择网格
- `approver-section`：审批人信息展示

## 常见问题

### Q1: 无法创建电子流？
**A:** 检查以下几点：
1. 是否已登录？
2. 是否已绑定伴侣？
3. 伴侣关系是否为 'paired'？
4. 查看控制台错误信息

### Q2: 无法编辑电子流？
**A:**
1. 确认该申请是自己创建的
2. 确认状态为"已驳回"
3. 其他状态（待审批、已完成）不允许编辑

### Q3: 提交后没反应？
**A:**
1. 检查网络连接
2. 查看云函数日志
3. 检查表单验证是否通过
4. 查看控制台错误信息

### Q4: 金额输入不对？
**A:**
- 只能输入数字和小数点
- 不能输入负数
- 选择"其他"类型时可以不填
- 其他类型必须填写且大于 0

## 性能优化

### 1. 数据缓存
- 用户信息缓存到本地
- 避免重复获取伴侣信息

### 2. 加载优化
- 异步加载用户和伴侣信息
- 编辑模式串行加载（先用户再详情）

### 3. 体验优化
- 提交时禁用按钮（防止重复提交）
- 显示明确的加载和成功提示
- 取消时二次确认

## 后续优化

1. [ ] 添加表单自动保存草稿
2. [ ] 支持上传附件
3. [ ] 支持选择多个审批人
4. [ ] 添加金额计算器
5. [ ] 支持历史记录快速填充
6. [ ] 添加表单验证动画
7. [ ] 优化键盘弹出体验

## 相关文件

- `/miniprogram/pages/editFlow/index.wxml` - 页面结构
- `/miniprogram/pages/editFlow/index.js` - 页面逻辑
- `/miniprogram/pages/editFlow/index.wxss` - 页面样式
- `/cloudfunctions/flowManager/index.js` - 云函数
