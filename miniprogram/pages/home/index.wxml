<!-- é¦–é¡µ - è®¾è®¡ç³»ç»Ÿé‡æ„ç‰ˆ -->
<view class="ds-page ds-page--with-decor">
  
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡åŒº -->
  <view class="ds-main">
    <view class="ds-card ds-card--strong user-card">
      <!-- æ¸¸å®¢æ¨¡å¼æç¤º -->
      <view wx:if="{{isGuest}}" class="guest-banner">
        <text class="guest-text">ğŸ‘‹ æ‚¨æ­£åœ¨ä»¥æ¸¸å®¢æ¨¡å¼æµè§ˆï¼Œ</text>
        <text class="guest-link" bindtap="requireLogin">ç‚¹å‡»ç™»å½•</text>
        <text class="guest-text">ä½“éªŒå®Œæ•´åŠŸèƒ½</text>
      </view>
      
      <view class="ds-row ds-row--between">
        <view class="ds-row" bindtap="goToSettings">
          <image class="user-avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="user-text">
            <text class="ds-text-subtitle">{{userInfo.nickName}}</text>
            <text class="ds-text-desc">{{isGuest ? 'ç™»å½•åå¯åˆ›å»ºç”³è¯·' : 'æ¬¢è¿å›æ¥ï½'}}</text>
          </view>
        </view>
        <view class="stat-badge" bindtap="goToStatistics">
          <text class="stat-label">æœ¬æœˆæ”¯å‡º â†’</text>
          <text class="stat-amount">Â¥{{monthlyExpense}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Tab æ ‡ç­¾æ  -->
  <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="tabs-container">
    <t-tab-panel label="æˆ‘çš„å¾…åŠ" value="todo" badge-props="{{todoCount > 0 ? {count: todoCount > 10 ? '10+' : todoCount} : null}}" />
    <t-tab-panel label="æˆ‘çš„ç”³è¯·" value="myapply" />
    <t-tab-panel label="å·²å®Œæˆ" value="completed" />
  </t-tabs>

  <!-- ç­›é€‰æ  -->
  <view class="filter-section">
    <view class="filter-chip {{currentFilter === 'all' ? 'active' : ''}}" bindtap="onFilterChange" data-filter="all">å…¨éƒ¨</view>
    <view class="filter-chip {{currentFilter === 'funds' ? 'active' : ''}}" bindtap="onFilterChange" data-filter="funds">æ‹¨æ¬¾</view>
    <view class="filter-chip {{currentFilter === 'travel' ? 'active' : ''}}" bindtap="onFilterChange" data-filter="travel">å‡ºè¡Œ</view>
    <view class="filter-chip {{currentFilter === 'other' ? 'active' : ''}}" bindtap="onFilterChange" data-filter="other">å…¶ä»–</view>
  </view>

  <!-- ç”µå­æµåˆ—è¡¨ -->
  <view class="flow-list">
    <!-- æœç´¢æ  -->
    <view class="search-section">
      <view class="search-bar">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input" 
          placeholder="æœç´¢ç”³è¯·å†…å®¹" 
          placeholder-class="search-placeholder"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearch"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
        />
        <view wx:if="{{searchKeyword}}" class="search-actions">
          <text class="search-clear" bindtap="onClearSearch">æ¸…ç©º</text>
          <view class="search-divider"></view>
          <text class="search-submit" bindtap="onSearch">æœç´¢</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{flowList.length === 0 && !loading}}" class="ds-empty">
      <text class="ds-empty__icon">ğŸ“‹</text>
      <text class="ds-empty__text">{{searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³æ•°æ®' : 'æš‚æ— æ•°æ®'}}</text>
    </view>
    
    <!-- åˆ—è¡¨é¡¹ -->
    <view wx:else>
      <view class="flow-card ds-card" wx:for="{{flowList}}" wx:key="id" bindtap="goToDetail" data-id="{{item.id}}">
        <view class="flow-header">
          <image class="flow-avatar" src="{{item.applicantAvatar}}" mode="aspectFill"></image>
          <view class="flow-info">
            <text class="flow-name">{{item.applicantName}}</text>
            <text class="flow-time">{{item.createTime}}</text>
          </view>
          <view class="flow-badges">
            <!-- çŠ¶æ€æ ‡ç­¾ -->
            <view class="ds-tag ds-tag--{{item.status === 'pending' ? 'yellow' : item.status === 'completed' ? 'success' : 'danger'}}">
              {{item.statusText}}
            </view>
          </view>
        </view>
        
        <view class="flow-content">{{item.content}}</view>
        
        <view class="flow-footer">
          <text class="flow-amount">Â¥{{item.amount}}</text>
          <view class="flow-type-tag ds-tag ds-tag--{{item.type}}">{{item.typeText}}</view>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view class="load-more">
        <view wx:if="{{loadingMore}}" class="load-more-loading">
          <text class="loading-dot"></text>
          <text class="loading-dot"></text>
          <text class="loading-dot"></text>
          <text class="load-more-text">åŠ è½½ä¸­...</text>
        </view>
        <view wx:elif="{{!hasMore && flowList.length > 0}}" class="load-more-end">
          <view class="end-line"></view>
          <text class="load-more-text">å·²åŠ è½½å®Œï¼Œå…± {{total}} æ¡æ•°æ®</text>
          <view class="end-line"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ–°å»ºç”µå­æµæŒ‰é’® -->
  <view class="ds-fab" bindtap="goToCreate">
    <text style="font-size: 64rpx; color: #FFFFFF; font-weight: 300; position: relative; z-index: 1;height: 48px;">+</text>
  </view>

  <!-- Toast æç¤º -->
  <t-toast id="t-toast" />
</view>
